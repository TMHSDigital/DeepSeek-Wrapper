<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek Wrapper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&family=Roboto+Mono:wght@400;500&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/settings-modal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.umd.min.js"></script>
    <script>
    // Ensure marked is available globally
    if (typeof marked === 'undefined') {
        console.error('Marked.js failed to load!');
    } else {
        console.log('Marked.js loaded successfully, version available');
    }
    </script>
    <script src="/static/settings-modal.js"></script>
    <style>
    #scroll-bottom {
        transition: opacity 0.2s;
        opacity: 0;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        right: 2em;
        bottom: 6em;
        z-index: 10;
    }
    #scroll-bottom.visible {
        opacity: 1;
        pointer-events: auto;
    }
    </style>
    <script>
    // Test function to verify JavaScript is working
    console.log('DeepSeek-Wrapper JavaScript loaded successfully');

    function scrollChat() {
        const chatHistoryElem = document.getElementById('chat-history');
        const scrollBottomBtn = document.getElementById('scroll-bottom');
        // Hide if no messages or empty chat
        if (!chatHistoryElem || chatHistoryElem.children.length === 0 || chatHistoryElem.querySelector('.empty-chat')) {
            scrollBottomBtn.classList.remove('visible');
            return;
        }
        // Show only if not at bottom
        const isScrolledUp = chatHistoryElem.scrollTop < chatHistoryElem.scrollHeight - chatHistoryElem.clientHeight - 100;
        if (isScrolledUp && chatHistoryElem.scrollHeight > chatHistoryElem.clientHeight) {
            scrollBottomBtn.classList.add('visible');
        } else {
            scrollBottomBtn.classList.remove('visible');
        }
    }

    // Date separators
    function formatDateSeparator(ts){
        const d = new Date(ts);
        const today = new Date();
        const isToday = d.toDateString() === today.toDateString();
        const yesterday = new Date();
        yesterday.setDate(today.getDate()-1);
        const isYesterday = d.toDateString() === yesterday.toDateString();
        if (isToday) return 'Today';
        if (isYesterday) return 'Yesterday';
        return d.toLocaleDateString(undefined, { weekday:'long', month:'short', day:'numeric', year: d.getFullYear()!==today.getFullYear()? 'numeric': undefined });
    }

    function maybeInsertDateSeparator(container, ts){
        const lastSep = container.querySelector('.date-separator:last-of-type');
        const label = formatDateSeparator(ts);
        const needs = !lastSep || lastSep.getAttribute('data-label') !== label;
        if (needs){
            const sep = document.createElement('div');
            sep.className = 'date-separator';
            sep.setAttribute('data-label', label);
            sep.innerHTML = `<span>${label}</span>`;
            container.appendChild(sep);
        }
    }
    function focusInput() {
        var input = document.getElementById('user_message');
        if (input) input.focus();
    }
    window.onload = function() {
        scrollChat();
        focusInput();
        autoResizeTextarea(document.getElementById('user_message'));
    };
    function handleKey(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChat();
        }
    }
    // Make autoResizeTextarea globally available
    window.autoResizeTextarea = function(textarea) {
        if (!textarea) {
            console.warn('autoResizeTextarea: textarea element not found');
            return;
        }
        textarea.style.height = 'auto'; // Temporarily shrink to get scrollHeight
        let newHeight = textarea.scrollHeight;
        const maxHeight = parseInt(getComputedStyle(textarea).maxHeight);
        if (maxHeight && newHeight > maxHeight) {
            newHeight = maxHeight;
            textarea.style.overflowY = 'auto';
        } else {
            textarea.style.overflowY = 'hidden';
        }
        textarea.style.height = newHeight + 'px';
    };

    // Verify function is available (debug-only)
    // console.log('autoResizeTextarea function defined:', typeof window.autoResizeTextarea === 'function');

    function sendChat() {
        var btn = document.getElementById('send-btn');
        var input = document.getElementById('user_message');
        var sendingStatus = document.getElementById('sending-status');
        var chatHistory = document.getElementById('chat-history');
        var emptyChatDiv = document.querySelector('.empty-chat');
        
        if (!input.value.trim()) return;
        if (emptyChatDiv) emptyChatDiv.style.display = 'none'; // Hide empty chat message
        
        if (btn) btn.disabled = true;
        if (sendingStatus) sendingStatus.style.display = 'block';
        
        const userMessageValue = input.value; // Capture value before clearing
        input.value = '';
        autoResizeTextarea(input); // Reset height after clearing
        
        // Encode user_message for URL query parameter
        const encodedUserMessage = encodeURIComponent(userMessageValue);

        // Create and handle the EventSource for streaming
        const eventSource = new EventSource(`/chat/stream?user_message=${encodedUserMessage}&_=${Date.now()}`, {
            withCredentials: true
        });
        
        let assistantMsgElement = null;
        let currentAssistantBubble = null;
        
        eventSource.addEventListener('message', function(e) {
            try {
                const data = JSON.parse(e.data);
                
                switch(data.type) {
                    case 'user_msg_received':
                        maybeInsertDateSeparator(chatHistory, Date.now());
                        const userMsgHtml = `
                            <div class="msg-row user" data-timestamp="${Date.now()}">
                                <div class="bubble user-msg">
                                    <span class="content">${data.message.content.replace(/\n/g, '<br>')}</span>
                                    <span class="timestamp">${data.message.timestamp}</span>
                                    <div class="message-actions">
                                        <button class="action-btn copy-btn" onclick="copyMessage(this)" aria-label="Copy message">
                                            <span class="action-tooltip">Copy</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="avatar">
                                    <span class="avatar-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                    </span>
                                </div>
                            </div>
                        `;
                        chatHistory.insertAdjacentHTML('beforeend', userMsgHtml);
                        applyMessageGrouping();
                        scrollChat();
                        break;
                        
                    case 'assistant_msg_start':
                        maybeInsertDateSeparator(chatHistory, Date.now());
                        const thinkingId = `thinking-details-${Date.now()}-${Math.floor(Math.random()*1e6)}`;
                        const assistantMsgHtml = `
                            <div class="msg-row assistant" data-timestamp="${Date.now()}">
                                <div class="avatar">
                                    <span class="avatar-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2"></path><path d="M10 8.484C13.207 7.894 14 11.138 14 12.5c0 .469-.003 1.22-.933 1.916"></path><path d="M15 9.5a3.5 3.5 0 0 0-3-2 3.5 3.5 0 0 0-3 2"></path><path d="M9.5 15a3.5 3.5 0 0 0 5 0"></path></svg>
                                    </span>
                                </div>
                                <div class="bubble assistant-msg">
                                    <div class="thinking-wrapper" data-expanded="false">
                                        <div class="thinking-header">
                                            <div class="thinking-title">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 14s1-1 4-1 5 2 8 2 5-1 6-2"></path><path d="M5 17s1-1 4-1 5 2 8 2 5-1 6-2"></path><path d="M8 20s1-1 4-1 5 2 8 2 5-1 6-2"></path></svg>
                                                <span>Thinking…</span>
                                            </div>
                                            <button class="thinking-toggle" aria-expanded="false" onclick="toggleThinking(this)" aria-controls="${thinkingId}">Show details</button>
                                        </div>
                                        <div class="thinking-bar" role="progressbar" aria-busy="true" aria-label="Thinking in progress" aria-live="polite">
                                            <div class="progress"></div>
                                        </div>
                                        <div class="thinking-details" id="${thinkingId}" hidden>
                                            <span class="content streaming-content" style="display: block;"></span>
                                        </div>
                                    </div>
                                    <span class="timestamp"></span>
                                    <div class="message-actions">
                                        <button class="action-btn copy-btn" onclick="copyMessage(this)" aria-label="Copy message">
                                            <span class="action-tooltip">Copy</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        chatHistory.insertAdjacentHTML('beforeend', assistantMsgHtml);
                        applyMessageGrouping();
                        const newAssistantRow = chatHistory.lastElementChild;
                        currentAssistantBubble = newAssistantRow.querySelector('.bubble.assistant-msg');
                        assistantMsgElement = currentAssistantBubble.querySelector('.thinking-details .content.streaming-content');
                        scrollChat();
                        break;
                        
                    case 'content_chunk':
                        if (assistantMsgElement) {
                            const chunk = data.chunk;
                            // Accumulate the full content for proper markdown rendering
                            if (!assistantMsgElement.dataset.fullContent) {
                                assistantMsgElement.dataset.fullContent = '';
                            }
                            assistantMsgElement.dataset.fullContent += chunk;

                            // If details are expanded, live-render; otherwise keep progress bar only
                            const thinkingWrapper = currentAssistantBubble.querySelector('.thinking-wrapper');
                            const details = currentAssistantBubble.querySelector('.thinking-details');
                            // Remember expansion per session
                            const expandedPref = sessionStorage.getItem('ds_thinking_expanded') === 'true';
                            if (thinkingWrapper && expandedPref) {
                                thinkingWrapper.setAttribute('data-expanded', 'true');
                                details.hidden = false;
                                const toggleBtn = currentAssistantBubble.querySelector('.thinking-toggle');
                                if (toggleBtn){ toggleBtn.textContent = 'Hide details'; toggleBtn.setAttribute('aria-expanded','true'); }
                            }
                            const isExpanded = thinkingWrapper && thinkingWrapper.getAttribute('data-expanded') === 'true';
                            if (isExpanded) {
                                try {
                                    const renderedContent = renderMarkdown(assistantMsgElement.dataset.fullContent);
                                    assistantMsgElement.innerHTML = renderedContent;
                                } catch (error) {
                                    console.warn('Markdown rendering error during streaming:', error);
                                    assistantMsgElement.innerHTML = assistantMsgElement.dataset.fullContent.replace(/\n/g, '<br>');
                                }
                            }
                            scrollChat();
                        }
                        break;
                        
                    case 'complete':
                        eventSource.close();
                        if (assistantMsgElement) {
                            // Use the accumulated content for final rendering (more reliable)
                            const finalContent = assistantMsgElement.dataset.fullContent || data.message.content;

                            // Ensure details section is visible when answer is complete
                            const wrapper = currentAssistantBubble.querySelector('.thinking-wrapper');
                            const details = currentAssistantBubble.querySelector('.thinking-details');
                            if (wrapper && details){
                                wrapper.setAttribute('data-expanded','true');
                                details.hidden = false;
                                const toggleBtn = currentAssistantBubble.querySelector('.thinking-toggle');
                                if (toggleBtn){ toggleBtn.textContent = 'Hide details'; toggleBtn.setAttribute('aria-expanded','true'); }
                                // Stop progress bar animation
                                const bar = currentAssistantBubble.querySelector('.thinking-bar .progress');
                                if (bar){ bar.style.animation = 'none'; bar.style.width = '100%'; }
                                // Ensure no flashing in details while rendering
                                const content = currentAssistantBubble.querySelector('.thinking-details .content.streaming-content');
                                if (content){ content.classList.remove('streaming-content'); }
                            }

                            try {
                                const renderedContent = renderMarkdown(finalContent);
                                assistantMsgElement.innerHTML = renderedContent;
                            } catch (error) {
                                console.warn('Final markdown rendering error:', error);
                                assistantMsgElement.innerHTML = finalContent.replace(/\n/g, '<br>');
                            }
                            assistantMsgElement.classList.remove('streaming-content');
                            // Clean up the dataset
                            delete assistantMsgElement.dataset.fullContent;
                        }
                        if(currentAssistantBubble){
                            currentAssistantBubble.querySelector('.timestamp').textContent = data.message.timestamp;
                            // Mark thinking bar complete and aria updates
                            const thinkingBar = currentAssistantBubble.querySelector('.thinking-bar');
                            if (thinkingBar) {
                                thinkingBar.setAttribute('aria-busy','false');
                                thinkingBar.setAttribute('aria-label','Thinking complete');
                            }
                        }
                        applyMessageGrouping();
                        sendingStatus.style.display = 'none';
                        btn.disabled = false;
                        focusInput();
                        break;
                        
                    case 'error':
                        eventSource.close();
                        const errorBanner = document.createElement('div');
                        errorBanner.className = 'error-banner';
                        errorBanner.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> ${data.error}`;
                        document.querySelector('.chat-container').appendChild(errorBanner); // Append to chat container
                        setTimeout(() => errorBanner.remove(), 5000); // Auto-remove after 5s
                        
                        sendingStatus.style.display = 'none';
                        btn.disabled = false;
                        focusInput();
                        break;
                }
            } catch (error) {
                console.error("Error processing event:", error);
            }
        });
        
        eventSource.addEventListener('error', function(e) {
            console.error('EventSource error:', e);
            eventSource.close();
            sendingStatus.style.display = 'none';
            btn.disabled = false;
            focusInput();
            const errorBanner = document.createElement('div');
            errorBanner.className = 'error-banner';
            errorBanner.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> Connection error. Please try again.`;
            document.querySelector('.chat-container').appendChild(errorBanner);
            setTimeout(() => errorBanner.remove(), 5000);
        });
    }
    
    // Toggle thinking details expansion
    function toggleThinking(btn){
        const wrapper = btn.closest('.thinking-wrapper');
        const expanded = wrapper.getAttribute('data-expanded') === 'true';
        const details = wrapper.querySelector('.thinking-details');
        wrapper.setAttribute('data-expanded', expanded ? 'false' : 'true');
        btn.setAttribute('aria-expanded', (!expanded).toString());
        btn.textContent = expanded ? 'Show details' : 'Hide details';
        if (details){
            if (expanded){
                details.hidden = true;
            } else {
                details.hidden = false;
            }
        }
        // Persist preference this session
        sessionStorage.setItem('ds_thinking_expanded', (!expanded).toString());
    }

    function renderMarkdown(text) {
        if (!text || typeof text !== 'string') {
            console.log('renderMarkdown: invalid input', {text, type: typeof text});
            return '';
        }

        // Keep logs quiet in production UI

        // Configure marked renderer for better handling of all elements
        const renderer = new marked.Renderer();

        // Custom heading renderer
        renderer.heading = function(text, level) {
            const sizes = {
                1: '1.5em',
                2: '1.3em',
                3: '1.15em',
                4: '1.1em',
                5: '1em',
                6: '1em'
            };
            const fontSize = sizes[level] || '1em';
            return `<h${level} style="margin: 1em 0 0.5em 0; font-weight: 600; font-size: ${fontSize};">${text}</h${level}>\n`;
        };

        // Custom list renderer
        renderer.list = function(body, ordered, start) {
            const tag = ordered ? 'ol' : 'ul';
            const attrs = ordered && start && start !== 1 ? ` start="${start}"` : '';
            return `<${tag}${attrs}>\n${body}</${tag}>\n`;
        };

        renderer.listitem = function(text) {
            return `<li>${text}</li>\n`;
        };

        // Custom paragraph renderer
        renderer.paragraph = function(text) {
            return `<p style="margin: 0.5em 0;">${text}</p>\n`;
        };

        // Custom strong/bold renderer
        renderer.strong = function(text) {
            return `<strong style="font-weight: 600;">${text}</strong>`;
        };

        // Custom emphasis renderer
        renderer.em = function(text) {
            return `<em style="font-style: italic;">${text}</em>`;
        };

        // Configure Marked.js for enhanced markdown support
        marked.setOptions({
            gfm: true,
            breaks: true,
            headerIds: false,
            langPrefix: 'language-',
            pedantic: false,
            smartLists: true,
            smartypants: true,
            renderer: renderer,
            highlight: function(code, lang) {
                // Use highlight.js for code syntax highlighting
                if (window.hljs) {
                    try {
                        const language = window.hljs.getLanguage(lang) ? lang : 'plaintext';
                        return window.hljs.highlight(code, { language }).value;
                    } catch (error) {
                        console.warn('Code highlighting error:', error);
                        return code;
                    }
                }
                return code;
            }
        });

        try {
            // Parse Markdown to HTML
            // Minimal logging to avoid console noise

            const html = marked.parse(text);
            

            // Add container for processing
            const container = document.createElement('div');
            container.innerHTML = html;

            // Add copy buttons to code blocks
            container.querySelectorAll('pre').forEach(preBlock => {
                // Create wrapper for the code block
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';

                // Create copy button
                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-copy-btn';
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
                copyBtn.setAttribute('aria-label', 'Copy code');

                // Create tooltip
                const tooltip = document.createElement('span');
                tooltip.className = 'code-copy-tooltip';
                tooltip.textContent = 'Copy';
                copyBtn.appendChild(tooltip);

                // Add click event to copy the code
                copyBtn.addEventListener('click', function() {
                    const code = preBlock.querySelector('code').textContent;
                    navigator.clipboard.writeText(code)
                        .then(() => {
                            tooltip.textContent = 'Copied!';
                            setTimeout(() => {
                                tooltip.textContent = 'Copy';
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Failed to copy code: ', err);
                        });
                });

                // Create language label if language is specified
                const codeBlock = preBlock.querySelector('code');
                if (codeBlock && codeBlock.className.includes('language-')) {
                    const langClass = Array.from(codeBlock.classList).find(cl => cl.startsWith('language-'));
                    if (langClass) {
                        const lang = langClass.replace('language-', '');
                        if (lang && lang !== 'plaintext') {
                            const langLabel = document.createElement('span');
                            langLabel.className = 'code-lang-label';
                            langLabel.textContent = lang;
                            wrapper.appendChild(langLabel);
                        }
                    }
                }

                // Add elements to DOM
                wrapper.appendChild(copyBtn);
                preBlock.parentNode.insertBefore(wrapper, preBlock);
                wrapper.appendChild(preBlock);
            });

            // Highlight code blocks after rendering
            setTimeout(() => {
                if (window.hljs) {
                    document.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightBlock(block);
                    });
                }
            }, 0);

            return container.innerHTML;
        } catch (error) {
            console.warn('Markdown rendering error:', error);
            console.log('Falling back to basic formatting');
            // Enhanced fallback to simple formatting
            return text
                .replace(/\n/g, '<br>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/^\d+\. (.*$)/gm, '<li>$1</li>')
                .replace(/^- (.*$)/gm, '<li>• $1</li>');
        }
    }
    // Settings functions - use the external implementation from settings-modal.js
    function openSettings() {
        openSettingsModal();
    }
    
    function closeSettings() {
        closeSettingsModal();
    }
    
    function saveSettings() {
        saveSettingsModal();
    }
    
    // Theme Toggle
    document.getElementById('theme-toggle').addEventListener('click', function() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    });

    // Keyboard shortcut hints in tooltips
    document.getElementById('export-btn')?.setAttribute('title','Export conversation (Alt+E)');
    document.getElementById('theme-toggle')?.setAttribute('title','Toggle theme (Alt+T)');
    document.getElementById('file-input')?.setAttribute('title','Attach file (Alt+U)');
    
    // Model indicator
    async function loadCurrentModel() {
        try {
            const response = await fetch('/api/models');
            const data = await response.json();
            
            if (data.success) {
                const indicator = document.getElementById('current-model-indicator');
                indicator.textContent = data.current_model;
                indicator.setAttribute('aria-live', 'polite');
                indicator.setAttribute('title', `Current model: ${data.current_model}`);
            } else {
                document.getElementById('current-model-indicator').textContent = 'Error';
            }
        } catch (error) {
            console.error('Error loading model info:', error);
            document.getElementById('current-model-indicator').textContent = 'Error';
        }
    }
    
    // Load model on page load
    loadCurrentModel();
    
        // Make model indicator clickable to open settings (Model tab)
        document.querySelector('.model-indicator').addEventListener('click', function() {
        // Open settings modal and switch to model tab
        openSettingsModal();
        
        // Switch to model tab
        document.querySelectorAll('.modal-tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.modal-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        document.querySelector('.modal-tab-btn[data-tab="model"]').classList.add('active');
        document.getElementById('model-tab').classList.add('active');
    });
    </script>
</head>
<body>
    <!-- Toasts Container -->
    <div id="toast-container"></div>

    <!-- Settings Modal -->
    {% include 'settings-modal.html' %}
    
    <!-- File Upload Modal -->
    <div class="container">
        <header class="top-bar">
            <h1 class="app-title">DeepSeek Wrapper</h1>
            <div class="model-indicator" title="Current model. Click to open Model settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2"></path><path d="M10 8.484C13.207 7.894 14 11.138 14 12.5c0 .469-.003 1.22-.933 1.916"></path><path d="M15 9.5a3.5 3.5 0 0 0-3-2 3.5 3.5 0 0 0-3 2"></path><path d="M9.5 15a3.5 3.5 0 0 0 5 0"></path></svg>
                <span id="current-model-indicator" class="model-loading">
                    <div class="model-spinner"></div>
                    Loading...
                </span>
            </div>
            <div class="top-actions">
                <button id="export-btn" class="export-btn" title="Export conversation (Alt+E)" aria-label="Export conversation" tabindex="0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    <span>Export</span>
                </button>
                <button id="settings-btn" class="theme-toggle" title="Settings" aria-label="Settings" tabindex="0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15.4a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 8c.14.31.22.65.22 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
                <button id="theme-toggle" class="theme-toggle" title="Toggle theme (Alt+T)" aria-label="Toggle dark/light theme" tabindex="0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="light-icon"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="dark-icon" style="display:none;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
            </div>
        </header>
        
        <main class="chat-container">
        <div id="chat-history" class="chat-history">
                {% if messages %}
            {% for msg in messages %}
                <div class="msg-row {{ msg.role }}">
                            {% if msg.role == 'assistant' %}
                            <div class="avatar">
                                <span class="avatar-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2"></path><path d="M10 8.484C13.207 7.894 14 11.138 14 12.5c0 .469-.003 1.22-.933 1.916"></path><path d="M15 9.5a3.5 3.5 0 0 0-3-2 3.5 3.5 0 0 0-3 2"></path><path d="M9.5 15a3.5 3.5 0 0 0 5 0"></path></svg>
                                </span>
                            </div>
                            {% endif %}
                    <div class="bubble {{ msg.role }}-msg">
                                <!-- <span class="role">{{ msg.role.title() }}</span> -->
                                <span class="content">{{ msg.content_html|safe }}</span>
                                <span class="timestamp">{{ msg.timestamp }}</span>
                                <div class="message-actions">
                                    <button class="action-btn copy-btn" onclick="copyMessage(this)" aria-label="Copy message">
                                        <span class="action-tooltip">Copy</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                    </button>
                                </div>
                            </div>
                            {% if msg.role == 'user' %}
                            <div class="avatar">
                                <span class="avatar-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                        {% else %}
                    <div class="empty-chat">
                        <div class="empty-chat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.056 3 11.61c0 1.64.506 3.192 1.397 4.512L3 20.25l5.25-1.837A8.963 8.963 0 0 0 12 20.25z"></path></svg>
                        </div>
                        <h2>Welcome to DeepSeek Wrapper</h2>
                        <p>Ask a question, paste code, or attach a file to begin.</p>
                    </div>
                        {% endif %}
                {% if loading %}
                    <div class="msg-row assistant loading-placeholder">
                        <div class="avatar">
                            <span class="avatar-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2"></path><path d="M10 8.484C13.207 7.894 14 11.138 14 12.5c0 .469-.003 1.22-.933 1.916"></path><path d="M15 9.5a3.5 3.5 0 0 0-3-2 3.5 3.5 0 0 0-3 2"></path><path d="M9.5 15a3.5 3.5 0 0 0 5 0"></path></svg>
                            </span>
                        </div>
                        <div class="bubble assistant-msg loading-bubble">
                            <div class="typing-indicator">
                                <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
                    </div>
                </div>
                </div>
            {% endif %}
            </div>
            <div id="scroll-bottom" class="scroll-bottom-btn" title="Scroll to bottom">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
        </main>

        <form id="chat-form" method="post" onsubmit="sendChat(); return false;">
            <textarea id="user_message" name="user_message" placeholder="Type your message... (Shift+Enter for newline)" required rows="1" oninput="autoResizeTextarea(this)" onkeydown="handleKey(event)" aria-label="Message input"></textarea>
            <input type="hidden" id="user_name_hidden" name="user_name" />
            <input type="hidden" id="user_avatar_hidden" name="user_avatar" />
            <input type="hidden" id="system_prompt_hidden" name="system_prompt" />
            <button id="send-btn" type="submit" {% if loading %}disabled{% endif %} aria-label="Send message">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
            <button type="button" onclick="document.getElementById('reset-form').submit();" class="reset-btn" aria-label="Reset conversation">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>
            </button>
        </form>
        <form id="reset-form" method="post" action="/reset" style="display:none;"></form>
        
        <form id="upload-form" enctype="multipart/form-data">
            <label for="file-input">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.49"></path></svg>
                Attach File
            </label>
            <input type="file" id="file-input" name="file" accept="image/*,.pdf,.txt,.doc,.docx" />
            <button id="upload-btn" type="submit" style="display:none;">Upload File</button> <!-- Hidden, triggered by JS if needed or label click -->
            <progress id="upload-progress" value="0" max="100" style="display:none;"></progress>
            <span id="upload-status"></span>
            <div id="file-chips" class="file-chips"></div>
            <div id="image-preview"></div>
        </form>
        <div id="sending-status" class="sending-indicator" style="display:none;"></div>

        <div id="upload-area" class="upload-area">
            <div class="upload-area-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            </div>
            <div class="upload-area-text">Drop files here or click to select</div>
        </div>
    </div>
    <script>
    // Theme Toggle, Scroll, Copy, Export, Drag/Drop, Keyboard shortcuts - existing JS
    const uploadForm = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn'); // Though hidden, might be used by JS
    const uploadProgress = document.getElementById('upload-progress');
    const uploadStatus = document.getElementById('upload-status');
    const imagePreview = document.getElementById('image-preview');
    const fileChips = document.getElementById('file-chips');

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const f = this.files[0];
            uploadStatus.textContent = `Selected: ${f.name}`;
            uploadProgress.style.display = 'block';
            // Render chip
            renderFileChip(f);
            // Automatically submit form on file selection
            submitUploadForm(); 
        }
    });

    function renderFileChip(file){
        if (!fileChips) return;
        fileChips.innerHTML = '';
        const chip = document.createElement('div');
        chip.className = 'file-chip';
        const sizeKb = Math.max(1, Math.round(file.size/1024));
        chip.innerHTML = `
            <span class="name" title="${file.name}">${file.name}</span>
            <span class="size">${sizeKb} KB</span>
            <button class="remove" aria-label="Remove file" title="Remove">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        `;
        chip.querySelector('button.remove').addEventListener('click', function(){
            // Clear selection
            fileInput.value = '';
            uploadStatus.textContent = '';
            uploadProgress.style.display = 'none';
            imagePreview.innerHTML = '';
            chip.remove();
        });
        fileChips.appendChild(chip);
    }

    async function submitUploadForm() {
        if (!fileInput.files.length) { 
            uploadStatus.textContent = 'No file selected'; 
            uploadProgress.style.display = 'none';
            return; 
        }
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        // Visually indicate upload start, even if button is hidden
        uploadStatus.textContent = 'Uploading...';
        uploadProgress.value = 0;
        uploadProgress.style.display = 'block';
        imagePreview.innerHTML = '';

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload', true);
        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                uploadProgress.value = (e.loaded / e.total) * 100;
            }
        };
        xhr.onload = function() {
            uploadProgress.style.display = 'none'; // Hide progress after completion/error
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                uploadStatus.textContent = '✓ Uploaded: ' + data.filename.substring(0,25)+(data.filename.length > 25 ? '...' : '');
                if (data.content_type.startsWith('image/')) {
                    const url = '/uploads/' + data.filename;
                    imagePreview.innerHTML = `<img src="${url}" alt="${data.filename}" />`;
                }
                // Clear chips after successful upload
                if (fileChips) fileChips.innerHTML = '';
                // Add file message to chat history via SSE or similar mechanism if desired
                // For now, just confirm upload
            } else {
                uploadStatus.textContent = '✗ Upload failed';
            }
            // Reset file input for next upload
            fileInput.value = ''; 
            // Hide status after a few seconds
            setTimeout(() => { 
                if (!fileInput.files.length) uploadStatus.textContent = ''; 
                imagePreview.innerHTML = '';
            }, 4000);
        };
        xhr.onerror = function() {
            uploadProgress.style.display = 'none';
            uploadStatus.textContent = '✗ Upload failed (network error)';
            fileInput.value = '';
            setTimeout(() => { 
                if (!fileInput.files.length) uploadStatus.textContent = '';
                imagePreview.innerHTML = ''; 
            }, 4000);
        };
        xhr.send(formData);
    }
    
    uploadForm.onsubmit = async function(e) { 
        e.preventDefault(); 
        submitUploadForm();
    };

    // Image paste support
    document.getElementById('user_message').addEventListener('paste', async function(e) {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const file = items[i].getAsFile();
                if (file) {
                    // Use a DataTransfer object to set files on the input
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    // Trigger change event to start upload
                    fileInput.dispatchEvent(new Event('change'));
                    e.preventDefault(); // Prevent pasting image data into textarea
                    break; // Handle first image found
                }
            }
        }
    });

    // Auto-resize textarea on input
    document.getElementById('user_message').addEventListener('input', function() {
        autoResizeTextarea(this);
    });
    
    window.addEventListener('DOMContentLoaded', function() {
        var sendingStatus = document.getElementById('sending-status');
        if (sendingStatus) sendingStatus.style.display = 'none';
        // Initial resize for any pre-filled content (unlikely here, but good practice)
        autoResizeTextarea(document.getElementById('user_message'));
    });
    const chatHistoryElem = document.getElementById('chat-history');
    const scrollBottomBtn = document.getElementById('scroll-bottom');
    
    chatHistoryElem.addEventListener('scroll', function() {
        const isScrolledUp = chatHistoryElem.scrollTop < chatHistoryElem.scrollHeight - chatHistoryElem.clientHeight - 100; // Increased threshold
        if (isScrolledUp) {
            scrollBottomBtn.classList.add('visible');
        } else {
            scrollBottomBtn.classList.remove('visible');
        }
    });
    
    scrollBottomBtn.addEventListener('click', function() {
        chatHistoryElem.scrollTop = chatHistoryElem.scrollHeight;
    });
    
    function scrollChat() {
        const chatHistoryElem = document.getElementById('chat-history');
        const scrollBottomBtn = document.getElementById('scroll-bottom');
        // Hide if no messages or empty chat
        if (!chatHistoryElem || chatHistoryElem.children.length === 0 || chatHistoryElem.querySelector('.empty-chat')) {
            scrollBottomBtn.classList.remove('visible');
            return;
        }
        // Show only if not at bottom
        const isScrolledUp = chatHistoryElem.scrollTop < chatHistoryElem.scrollHeight - chatHistoryElem.clientHeight - 100;
        if (isScrolledUp && chatHistoryElem.scrollHeight > chatHistoryElem.clientHeight) {
            scrollBottomBtn.classList.add('visible');
        } else {
            scrollBottomBtn.classList.remove('visible');
        }
    }
    function copyMessage(button) {
        const bubble = button.closest('.bubble');
        if (!bubble) return;
        
        // Get text content from the message bubble
        const content = bubble.querySelector('.content');
        let textToCopy = '';
        
        // If it's a rendered markdown content with HTML, we need to extract the text
        if (content.innerHTML.includes('<')) {
            // Create a temporary div to help extract text
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;
            
            // Handle code blocks specially - preserve formatting
            const codeBlocks = tempDiv.querySelectorAll('pre code');
            codeBlocks.forEach(block => {
                // Replace the code block with a placeholder that won't be affected by textContent
                const placeholder = `__CODE_BLOCK_${Math.random().toString(36).substr(2, 9)}__`;
                block._placeholder = placeholder;
                block._content = block.textContent;
                block.parentNode.textContent = placeholder;
            });
            
            // Get text content
            textToCopy = tempDiv.textContent;
            
            // Put back code blocks with proper formatting
            codeBlocks.forEach(block => {
                textToCopy = textToCopy.replace(block._placeholder, '\n```\n' + block._content + '\n```\n');
            });
        } else {
            // Simple text content
            textToCopy = content.textContent;
        }
        
        // Copy to clipboard
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                const tooltip = button.querySelector('.action-tooltip');
                const originalText = tooltip.textContent;
                tooltip.textContent = 'Copied!';
                tooltip.style.opacity = '1';
                setTimeout(() => {
                    tooltip.textContent = originalText;
                    tooltip.style.opacity = '';
                }, 1200);
                // Also show toast
                if (typeof showToast === 'function') {
                    showToast('Message copied');
                }
            })
            .catch(err => {
                console.error('Failed to copy text: ', err);
            });
    }
    const themeToggle = document.getElementById('theme-toggle');
    const htmlElement = document.documentElement;
    const lightIcon = themeToggle.querySelector('.light-icon');
    const darkIcon = themeToggle.querySelector('.dark-icon');
    
    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    setTheme(savedTheme);
    
    themeToggle.addEventListener('click', function() {
        const currentTheme = htmlElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
        localStorage.setItem('theme', newTheme);
    });
    
    function setTheme(theme) {
        htmlElement.setAttribute('data-theme', theme);
        if (theme === 'light') {
            lightIcon.style.display = 'inline-block';
            darkIcon.style.display = 'none';
        } else {
            lightIcon.style.display = 'none';
            darkIcon.style.display = 'inline-block';
        }
    }

    // Settings button direct event listener
    document.addEventListener('DOMContentLoaded', function() {
        // Settings button handling - one clean implementation
        const settingsBtn = document.getElementById('settings-btn');
        if (settingsBtn) {
            console.log('Attaching settings button listener');
            // Remove any existing onclick attribute to prevent conflicts
            settingsBtn.removeAttribute('onclick');
            
            // Add event listener
            settingsBtn.addEventListener('click', function(e) {
                console.log('Settings button clicked');
                e.preventDefault(); // Prevent any default behavior
                
                if (typeof window.openSettingsModal === 'function') {
                    window.openSettingsModal();
                } else {
                    console.error('openSettingsModal function not found - this should not happen');
                    alert('Settings functionality is not available. Please reload the page.');
                }
            });
        }
    });

    const uploadArea = document.getElementById('upload-area');
    // const fileInput = document.getElementById('file-input'); // Already defined
    
    document.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('visible');
    });
    
    document.addEventListener('dragleave', function(e) {
        // Check if the leave event is truly leaving the window/document or just moving over child elements
        if (!e.relatedTarget || e.relatedTarget.nodeName === 'HTML') {
            uploadArea.classList.remove('visible');
        } else if (e.clientX === 0 && e.clientY === 0) { // Heuristic for leaving window
             uploadArea.classList.remove('visible');
        }
    });
        
    uploadArea.addEventListener('dragover', function(e) { /* e.preventDefault(); is in global */ this.classList.add('drag-over'); });
    uploadArea.addEventListener('dragleave', function() { this.classList.remove('drag-over'); });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        this.classList.remove('visible');
        
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event('change')); // Trigger upload
        }
    });
    
    uploadArea.addEventListener('click', function() { fileInput.click(); });
    
    document.getElementById('export-btn').addEventListener('click', function() {
        const messages = Array.from(document.querySelectorAll('.msg-row'));
        let text = `# DeepSeek Wrapper Export - ${new Date().toLocaleString()}\n\n`;
        messages.forEach(msg => {
            const isUser = msg.classList.contains('user');
            const role = isUser ? 'User' : 'Assistant';
            const contentEl = msg.querySelector('.content');
            const time = msg.querySelector('.timestamp').textContent;
            
            // Create a temporary div to get innerText without HTML tags from markdown
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = contentEl.innerHTML.replace(/<br\s*\/?>/ig, '\n'); // Convert <br> to newlines
            const content = tempDiv.innerText || tempDiv.textContent || '';
            
            text += `## ${role} (${time})\n\n${content.trim()}\n\n---\n\n`;
        });
        
        const blob = new Blob([text], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `deepseek-wrapper-export-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.md`;
        document.body.appendChild(a); // Required for Firefox
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.altKey && e.key === 't') { e.preventDefault(); document.getElementById('theme-toggle').click(); }
        if (e.altKey && e.key === 'e') { e.preventDefault(); document.getElementById('export-btn').click(); }
        if (e.altKey && e.key === 'u') { e.preventDefault(); document.getElementById('file-input').click(); } // Updated to click label effectively
        if (e.altKey && e.key === 's') { e.preventDefault(); document.getElementById('user_message').focus(); }
        if (e.ctrlKey && e.key.toLowerCase() === 'k') { e.preventDefault(); openSettingsModal(); }
        if (e.key === 'Escape') {
            if (uploadArea.classList.contains('visible')) uploadArea.classList.remove('visible');
        }
    });

    // Basic toast system (ARIA live region)
    (function initToasts(){
        const container = document.getElementById('toast-container');
        if (!container) return;
        container.setAttribute('aria-live','polite');
        container.setAttribute('role','status');
    })();

    // Minimal command palette overlay (Ctrl+K) for common actions
    (function initPalette(){
        const overlay = document.createElement('div');
        overlay.id = 'cmdk-overlay';
        overlay.style.cssText = 'position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.35);z-index:10001;';
        overlay.innerHTML = `
            <div id="cmdk" role="dialog" aria-modal="true" aria-label="Command Palette" style="margin-top:10vh;background:var(--bg-main);color:var(--text-primary);border:1px solid var(--border-color);border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.25);width:min(680px,90vw);overflow:hidden;">
              <div style="padding:.75rem 1rem;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input id="cmdk-input" placeholder="Type a command… (e.g., Settings, Theme, Export)" aria-label="Command input" style="flex:1;border:none;outline:none;background:transparent;color:inherit;font-size:1rem;" />
                <span style="font-size:.75rem;color:var(--text-secondary);">Esc</span>
              </div>
              <div id="cmdk-list" style="max-height:50vh;overflow:auto;padding:.25rem 0;">
              </div>
            </div>`;
        document.body.appendChild(overlay);

        const actions = [
            { id:'settings', label:'Open Settings', hint:'Ctrl+K, type: settings', run: () => openSettingsModal() },
            { id:'model', label:'Open Model tab', hint:'Go to Model', run: () => { openSettingsModal(); document.querySelector('.modal-tab-btn[data-tab="model"]').click(); } },
            { id:'theme', label:'Toggle Theme', hint:'Alt+T', run: () => document.getElementById('theme-toggle').click() },
            { id:'export', label:'Export Conversation', hint:'Alt+E', run: () => document.getElementById('export-btn').click() },
            { id:'focus', label:'Focus Input', hint:'Alt+S', run: () => document.getElementById('user_message').focus() },
            { id:'clear', label:'Reset Conversation', hint:'Clear chat', run: () => document.getElementById('reset-form').submit() }
        ];

        function open(){ overlay.style.display='flex'; const input = document.getElementById('cmdk-input'); input.value=''; render(actions); setTimeout(()=>input.focus(), 0); }
        function close(){ overlay.style.display='none'; }
        function render(list){
            const listEl = document.getElementById('cmdk-list');
            listEl.innerHTML = '';
            list.forEach(a => {
                const item = document.createElement('button');
                item.type = 'button';
                item.style.cssText = 'display:flex;justify-content:space-between;align-items:center;width:100%;text-align:left;padding:.6rem 1rem;background:transparent;border:none;border-bottom:1px solid var(--border-color);color:var(--text-primary);cursor:pointer';
                item.innerHTML = `<span>${a.label}</span><span style="font-size:.8rem;color:var(--text-secondary)">${a.hint}</span>`;
                item.addEventListener('click', () => { a.run(); close(); });
                item.addEventListener('mouseover', () => item.style.background = 'rgba(0,0,0,0.04)');
                item.addEventListener('mouseout', () => item.style.background = 'transparent');
                listEl.appendChild(item);
            });
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 'k') {
                e.preventDefault();
                if (overlay.style.display === 'flex') close(); else open();
            } else if (e.key === 'Escape' && overlay.style.display === 'flex') {
                close();
            }
        });

        overlay.addEventListener('click', (e) => { if (e.target === overlay) close(); });
        overlay.querySelector('#cmdk-input').addEventListener('input', function(){
            const q = this.value.toLowerCase();
            const filtered = actions.filter(a => a.label.toLowerCase().includes(q) || a.id.includes(q));
            render(filtered);
        });
    })();
    
    document.addEventListener('keyup', function(e) { if (e.key === 'Tab') document.body.classList.add('keyboard-nav'); });
    document.addEventListener('mousedown', function() { document.body.classList.remove('keyboard-nav'); });
    
    // Tool integration handling
    function insertToolPrompt(toolName, promptText) {
        const messageInput = document.getElementById('user_message');
        messageInput.value = promptText;
        messageInput.focus();
        
        // Place cursor at the end of text
        const textLength = messageInput.value.length;
        messageInput.setSelectionRange(textLength, textLength);
        
        // Auto-resize the textarea
        autoResizeTextarea(messageInput);
    }
    
    // Add tool quick access buttons in footer
    function createToolButton(toolName, icon, promptText) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'tool-quick-btn';
        button.title = `Use ${toolName}`;
        button.innerHTML = icon;
        button.addEventListener('click', function() {
            insertToolPrompt(toolName, promptText);
        });
        return button;
    }
    
    window.addEventListener('DOMContentLoaded', function() {
        // Set hidden fields from localStorage
        document.getElementById('user_name_hidden').value = localStorage.getItem('ds_username') || 'User';
        document.getElementById('user_avatar_hidden').value = localStorage.getItem('ds_avatar') || 'U';
        document.getElementById('system_prompt_hidden').value = localStorage.getItem('ds_system_prompt') || 'You are DeepSeek Chat, a helpful AI assistant.';
    });

    // Handle settings modal tabs
    document.querySelectorAll('.modal-tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            const tabName = button.getAttribute('data-tab');
            
            // Deactivate all tabs
            document.querySelectorAll('.modal-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('.modal-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activate selected tab
            button.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        });
    });
    
    // Tool caches are now handled in settings-modal.js
    
    // Initial API key status check
    </script>

    <!-- Function to handle message grouping -->
    <script>
    function applyMessageGrouping() {
        const messages = document.querySelectorAll('.msg-row');
        if (messages.length < 2) return;
        
        // Loop through messages starting from the second one
        for (let i = 1; i < messages.length; i++) {
            const currentMsg = messages[i];
            const prevMsg = messages[i-1];
            
            // Check if current and previous messages are from the same sender
            const isSameSender = 
                (currentMsg.classList.contains('user') && prevMsg.classList.contains('user')) ||
                (currentMsg.classList.contains('assistant') && prevMsg.classList.contains('assistant'));
            
            // Add or remove grouped class
            if (isSameSender) {
                currentMsg.classList.add('grouped');
            } else {
                currentMsg.classList.remove('grouped');
            }
        }
    }
    
    // Apply grouping on initial load
    document.addEventListener('DOMContentLoaded', function() {
        applyMessageGrouping();
    });
    </script>
</body>
</html> 