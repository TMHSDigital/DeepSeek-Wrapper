<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&family=Roboto+Mono:wght@400;500&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
    .modal-backdrop { position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; display:none; }
    .modal { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; color:#222; border-radius:8px; box-shadow:0 2px 16px rgba(0,0,0,0.2); z-index:1001; min-width:320px; max-width:90vw; padding:2em 1.5em; display:none; }
    .modal h2 { margin-bottom:1em; font-size:1.2em; }
    .modal label { display:block; margin:0.5em 0 0.2em; font-weight:500; }
    .modal input, .modal textarea { width:100%; margin-bottom:1em; padding:0.5em; border-radius:4px; border:1px solid #ccc; font-size:1em; }
    .modal-actions { text-align:right; }
    .modal-actions button { margin-left:0.5em; }
    #scroll-bottom {
        transition: opacity 0.2s;
        opacity: 0;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        right: 2em;
        bottom: 6em;
        z-index: 10;
    }
    #scroll-bottom.visible {
        opacity: 1;
        pointer-events: auto;
    }
    </style>
    <script>
    function scrollChat() {
        const chatHistoryElem = document.getElementById('chat-history');
        const scrollBottomBtn = document.getElementById('scroll-bottom');
        // Hide if no messages or empty chat
        if (!chatHistoryElem || chatHistoryElem.children.length === 0 || chatHistoryElem.querySelector('.empty-chat')) {
            scrollBottomBtn.classList.remove('visible');
            return;
        }
        // Show only if not at bottom
        const isScrolledUp = chatHistoryElem.scrollTop < chatHistoryElem.scrollHeight - chatHistoryElem.clientHeight - 100;
        if (isScrolledUp && chatHistoryElem.scrollHeight > chatHistoryElem.clientHeight) {
            scrollBottomBtn.classList.add('visible');
        } else {
            scrollBottomBtn.classList.remove('visible');
        }
    }
    function focusInput() {
        var input = document.getElementById('user_message');
        if (input) input.focus();
    }
    window.onload = function() {
        scrollChat();
        focusInput();
        autoResizeTextarea(document.getElementById('user_message'));
    };
    function handleKey(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChat();
        }
    }
    function autoResizeTextarea(textarea) {
        if (!textarea) return;
        textarea.style.height = 'auto'; // Temporarily shrink to get scrollHeight
        let newHeight = textarea.scrollHeight;
        const maxHeight = parseInt(getComputedStyle(textarea).maxHeight);
        if (maxHeight && newHeight > maxHeight) {
            newHeight = maxHeight;
            textarea.style.overflowY = 'auto';
        } else {
            textarea.style.overflowY = 'hidden';
        }
        textarea.style.height = newHeight + 'px';
    }
    function sendChat() {
        var btn = document.getElementById('send-btn');
        var input = document.getElementById('user_message');
        var sendingStatus = document.getElementById('sending-status');
        var chatHistory = document.getElementById('chat-history');
        var emptyChatDiv = document.querySelector('.empty-chat');
        
        if (!input.value.trim()) return;
        if (emptyChatDiv) emptyChatDiv.style.display = 'none'; // Hide empty chat message
        
        if (btn) btn.disabled = true;
        if (sendingStatus) sendingStatus.style.display = 'block';
        
        const userMessageValue = input.value; // Capture value before clearing
        input.value = '';
        autoResizeTextarea(input); // Reset height after clearing
        
        // Encode user_message for URL query parameter
        const encodedUserMessage = encodeURIComponent(userMessageValue);

        // Create and handle the EventSource for streaming
        const eventSource = new EventSource(`/chat/stream?user_message=${encodedUserMessage}&_=${Date.now()}`, {
            withCredentials: true
        });
        
        let assistantMsgElement = null;
        let currentAssistantBubble = null;
        
        eventSource.addEventListener('message', function(e) {
            try {
                const data = JSON.parse(e.data);
                
                switch(data.type) {
                    case 'user_msg_received':
                        const userMsgHtml = `
                            <div class="msg-row user">
                                <div class="bubble user-msg">
                                    <span class="content">${data.message.content.replace(/\n/g, '<br>')}</span>
                                    <span class="timestamp">${data.message.timestamp}</span>
                                    <div class="message-actions">
                                        <button class="action-btn copy-btn" onclick="copyMessage(this)" aria-label="Copy message">
                                            <span class="action-tooltip">Copy</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="avatar">
                                    <span class="avatar-letter">U</span>
                                </div>
                            </div>
                        `;
                        chatHistory.insertAdjacentHTML('beforeend', userMsgHtml);
                        scrollChat();
                        break;
                        
                    case 'assistant_msg_start':
                        const assistantMsgHtml = `
                            <div class="msg-row assistant">
                                <div class="avatar">
                                    <span class="avatar-letter">A</span>
                                </div>
                                <div class="bubble assistant-msg">
                                    <span class="content streaming-content" style="display: block;">
                                        <div class="typing-indicator">
                                            <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
                                        </div>
                                    </span>
                                    <span class="timestamp"></span>
                                     <div class="message-actions">
                                        <button class="action-btn copy-btn" onclick="copyMessage(this)" aria-label="Copy message">
                                            <span class="action-tooltip">Copy</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        chatHistory.insertAdjacentHTML('beforeend', assistantMsgHtml);
                        const newAssistantRow = chatHistory.lastElementChild;
                        currentAssistantBubble = newAssistantRow.querySelector('.bubble.assistant-msg');
                        assistantMsgElement = currentAssistantBubble.querySelector('.content.streaming-content');
                        scrollChat();
                        break;
                        
                    case 'content_chunk':
                        if (assistantMsgElement) {
                            if (assistantMsgElement.querySelector('.typing-indicator')) {
                                assistantMsgElement.innerHTML = ''; 
                            }
                            const chunk = data.chunk;
                            assistantMsgElement.innerHTML += chunk.replace(/\n/g, '<br>');
                            scrollChat();
                        }
                        break;
                        
                    case 'complete':
                        eventSource.close();
                        if (assistantMsgElement) {
                            if (assistantMsgElement.querySelector('.typing-indicator')) {
                                assistantMsgElement.innerHTML = '';
                            }
                            const finalContent = renderMarkdown(data.message.content);
                            assistantMsgElement.innerHTML = finalContent;
                            assistantMsgElement.classList.remove('streaming-content');
                        }
                        if(currentAssistantBubble){
                            currentAssistantBubble.querySelector('.timestamp').textContent = data.message.timestamp;
                        }
                        sendingStatus.style.display = 'none';
                        btn.disabled = false;
                        focusInput();
                        break;
                        
                    case 'error':
                        eventSource.close();
                        const errorBanner = document.createElement('div');
                        errorBanner.className = 'error-banner';
                        errorBanner.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> ${data.error}`;
                        document.querySelector('.chat-container').appendChild(errorBanner); // Append to chat container
                        setTimeout(() => errorBanner.remove(), 5000); // Auto-remove after 5s
                        
                        sendingStatus.style.display = 'none';
                        btn.disabled = false;
                        focusInput();
                        break;
                }
            } catch (error) {
                console.error("Error processing event:", error);
            }
        });
        
        eventSource.addEventListener('error', function(e) {
            console.error('EventSource error:', e);
            eventSource.close();
            sendingStatus.style.display = 'none';
            btn.disabled = false;
            focusInput();
            const errorBanner = document.createElement('div');
            errorBanner.className = 'error-banner';
            errorBanner.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> Connection error. Please try again.`;
            document.querySelector('.chat-container').appendChild(errorBanner);
            setTimeout(() => errorBanner.remove(), 5000);
        });
    }
    
    function renderMarkdown(text) {
        // Use Marked.js for full markdown support
        const html = marked.parse(text);
        // Highlight code blocks after rendering
        setTimeout(() => { if (window.hljs) hljs.highlightAll(); }, 0);
        return html;
    }
    // Settings modal logic
    function openSettings() {
        document.getElementById('modal-backdrop').style.display = 'block';
        document.getElementById('settings-modal').style.display = 'block';
        
        // Load from localStorage
        document.getElementById('settings-username').value = localStorage.getItem('ds_username') || 'User';
        document.getElementById('settings-avatar').value = localStorage.getItem('ds_avatar') || 'U';
        document.getElementById('settings-system-prompt').value = localStorage.getItem('ds_system_prompt') || 'You are DeepSeek Chat, a helpful AI assistant.';
        
        // Load tool settings and API keys
        loadToolSettings();
    }
    
    function closeSettings() {
        document.getElementById('modal-backdrop').style.display = 'none';
        document.getElementById('settings-modal').style.display = 'none';
    }
    
    function saveSettings() {
        // Save general settings
        localStorage.setItem('ds_username', document.getElementById('settings-username').value);
        localStorage.setItem('ds_avatar', document.getElementById('settings-avatar').value);
        localStorage.setItem('ds_system_prompt', document.getElementById('settings-system-prompt').value);
        document.getElementById('user_name_hidden').value = document.getElementById('settings-username').value;
        document.getElementById('user_avatar_hidden').value = document.getElementById('settings-avatar').value;
        document.getElementById('system_prompt_hidden').value = document.getElementById('settings-system-prompt').value;
        
        // Save tool settings
        saveToolSettings();
        
        closeSettings();
    }
    
    function loadToolSettings() {
        // Load tool toggle states
        document.getElementById('tool-websearch-toggle').checked = localStorage.getItem('tool_websearch_enabled') !== 'false';
        document.getElementById('tool-weather-toggle').checked = localStorage.getItem('tool_weather_enabled') !== 'false';
        document.getElementById('tool-email-toggle').checked = localStorage.getItem('tool_email_enabled') !== 'false';
        document.getElementById('tool-calculator-toggle').checked = localStorage.getItem('tool_calculator_enabled') !== 'false';
        document.getElementById('tool-date-toggle').checked = localStorage.getItem('tool_date_enabled') !== 'false';
        
        // Load API keys from localStorage (these are stored temporarily until explicitly saved to .env)
        document.getElementById('websearch-api-key').value = localStorage.getItem('websearch_api_key') || '';
        document.getElementById('weather-api-key').value = localStorage.getItem('weather_api_key') || '';
        document.getElementById('email-smtp-server').value = localStorage.getItem('email_smtp_server') || '';
        document.getElementById('email-username').value = localStorage.getItem('email_username') || '';
        document.getElementById('email-password').value = localStorage.getItem('email_password') || '';
        
        // Show/hide tool config bodies based on toggle state
        updateToolConfigVisibility();
    }
    
    function saveToolSettings() {
        // Save tool toggle states
        localStorage.setItem('tool_websearch_enabled', document.getElementById('tool-websearch-toggle').checked);
        localStorage.setItem('tool_weather_enabled', document.getElementById('tool-weather-toggle').checked);
        localStorage.setItem('tool_email_enabled', document.getElementById('tool-email-toggle').checked);
        localStorage.setItem('tool_calculator_enabled', document.getElementById('tool-calculator-toggle').checked);
        localStorage.setItem('tool_date_enabled', document.getElementById('tool-date-toggle').checked);
        
        // Save API keys to localStorage temporarily
        localStorage.setItem('websearch_api_key', document.getElementById('websearch-api-key').value);
        localStorage.setItem('weather_api_key', document.getElementById('weather-api-key').value);
        localStorage.setItem('email_smtp_server', document.getElementById('email-smtp-server').value);
        localStorage.setItem('email_username', document.getElementById('email-username').value);
        localStorage.setItem('email_password', document.getElementById('email-password').value);
    }
    
    function saveApiKeys() {
        // Create an object with all API key data
        const apiKeys = {
            WEBSEARCH_API_KEY: document.getElementById('websearch-api-key').value,
            WEATHER_API_KEY: document.getElementById('weather-api-key').value,
            EMAIL_SMTP_SERVER: document.getElementById('email-smtp-server').value,
            EMAIL_USERNAME: document.getElementById('email-username').value,
            EMAIL_PASSWORD: document.getElementById('email-password').value
        };
        
        // Only send non-empty values
        const keysToSave = {};
        for (const [key, value] of Object.entries(apiKeys)) {
            if (value.trim() !== '') {
                keysToSave[key] = value;
            }
        }
        
        // Send API keys to server to be saved in .env file
        if (Object.keys(keysToSave).length > 0) {
            fetch('/save_api_keys', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(keysToSave)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('API keys saved successfully!');
                } else {
                    alert('Error saving API keys: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving API keys. Check console for details.');
            });
        } else {
            alert('No API keys to save.');
        }
    }
    
    function updateToolConfigVisibility() {
        // Show/hide tool config bodies based on toggle state
        const toolItems = document.querySelectorAll('.tool-config-item');
        toolItems.forEach(item => {
            const header = item.querySelector('.tool-config-header');
            const body = item.querySelector('.tool-config-body');
            const toggle = header.querySelector('input[type="checkbox"]');
            
            // Only show body if exists and toggle is checked
            if (body && toggle && !toggle.checked) {
                body.style.display = 'none';
            } else if (body) {
                body.style.display = 'block';
            }
            
            // Add click handler to header
            header.addEventListener('click', function(e) {
                // Don't trigger when clicking on the toggle itself
                if (e.target.tagName !== 'INPUT') {
                    if (toggle) {
                        toggle.checked = !toggle.checked;
                        // Trigger change event
                        toggle.dispatchEvent(new Event('change'));
                    }
                }
            });
        });
    }
    
    window.addEventListener('DOMContentLoaded', function() {
        // Set hidden fields from localStorage
        document.getElementById('user_name_hidden').value = localStorage.getItem('ds_username') || 'User';
        document.getElementById('user_avatar_hidden').value = localStorage.getItem('ds_avatar') || 'U';
        document.getElementById('system_prompt_hidden').value = localStorage.getItem('ds_system_prompt') || 'You are DeepSeek Chat, a helpful AI assistant.';
        
        // Set up settings tabs
        const tabButtons = document.querySelectorAll('.settings-tab-btn');
        const tabContents = document.querySelectorAll('.settings-tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // Deactivate all tabs
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Activate clicked tab
                this.classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
            });
        });
        
        // Set up tool toggle event handlers
        const toggles = document.querySelectorAll('.tool-config-header input[type="checkbox"]');
        toggles.forEach(toggle => {
            toggle.addEventListener('change', function() {
                const toolConfigItem = this.closest('.tool-config-item');
                const configBody = toolConfigItem.querySelector('.tool-config-body');
                
                if (configBody) {
                    configBody.style.display = this.checked ? 'block' : 'none';
                }
            });
        });
        
        // Set up API keys save button
        document.getElementById('save-api-keys-btn').addEventListener('click', saveApiKeys);
    });
    </script>
</head>
<body>
    <div class="modal-backdrop" id="modal-backdrop" onclick="closeSettings()"></div>
    <div class="modal" id="settings-modal">
        <h2>Chat Settings</h2>
        <div class="settings-tabs">
            <button class="settings-tab-btn active" data-tab="general">General</button>
            <button class="settings-tab-btn" data-tab="tools">Tools</button>
        </div>
        
        <div class="settings-tab-content active" id="general-tab">
            <label for="settings-username">Your Name</label>
            <input id="settings-username" maxlength="32" />
            <label for="settings-avatar">Avatar (letter or emoji)</label>
            <input id="settings-avatar" maxlength="2" />
            <label for="settings-system-prompt">System Prompt</label>
            <textarea id="settings-system-prompt" rows="4"></textarea>
        </div>
        
        <div class="settings-tab-content" id="tools-tab">
            <div class="tool-config-list">
                <div class="tool-config-item">
                    <div class="tool-config-header">
                        <div class="tool-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                        <div class="tool-details">
                            <span class="tool-name">Web Search</span>
                            <span class="tool-description">Search the web for real-time information</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="tool-websearch-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="tool-config-body">
                        <label for="websearch-api-key">API Key</label>
                        <input type="password" id="websearch-api-key" placeholder="Enter your web search API key" />
                        <small>This will be saved in your .env file</small>
                    </div>
                </div>
                
                <div class="tool-config-item">
                    <div class="tool-config-header">
                        <div class="tool-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>
                        </div>
                        <div class="tool-details">
                            <span class="tool-name">Weather</span>
                            <span class="tool-description">Get weather information</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="tool-weather-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="tool-config-body">
                        <label for="weather-api-key">API Key</label>
                        <input type="password" id="weather-api-key" placeholder="Enter your weather API key" />
                        <small>This will be saved in your .env file</small>
                    </div>
                </div>
                
                <div class="tool-config-item">
                    <div class="tool-config-header">
                        <div class="tool-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                        </div>
                        <div class="tool-details">
                            <span class="tool-name">Email</span>
                            <span class="tool-description">Compose and send emails</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="tool-email-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="tool-config-body">
                        <label for="email-smtp-server">SMTP Server</label>
                        <input type="text" id="email-smtp-server" placeholder="smtp.example.com" />
                        <label for="email-username">SMTP Username</label>
                        <input type="text" id="email-username" placeholder="Your email" />
                        <label for="email-password">SMTP Password</label>
                        <input type="password" id="email-password" placeholder="Your password" />
                        <small>This will be saved in your .env file</small>
                    </div>
                </div>
                
                <div class="tool-config-item">
                    <div class="tool-config-header">
                        <div class="tool-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><line x1="8" y1="18" x2="12" y2="18"></line><line x1="8" y1="14" x2="12" y2="14"></line><line x1="8" y1="10" x2="16" y2="10"></line></svg>
                        </div>
                        <div class="tool-details">
                            <span class="tool-name">Calculator</span>
                            <span class="tool-description">Perform calculations</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="tool-calculator-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="tool-config-item">
                    <div class="tool-config-header">
                        <div class="tool-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        </div>
                        <div class="tool-details">
                            <span class="tool-name">Date & Time</span>
                            <span class="tool-description">Get current date and time information</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="tool-date-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <button id="save-api-keys-btn" class="save-api-btn">Save API Keys</button>
            </div>
        </div>
        
        <div class="modal-actions">
            <button onclick="closeSettings()">Cancel</button>
            <button onclick="saveSettings()">Save</button>
        </div>
    </div>
    <div class="container">
        <header class="top-bar">
            <h1 class="app-title">DeepSeek Chat</h1>
            <div class="top-actions">
                <button id="export-btn" class="export-btn" title="Export conversation (Alt+E)" aria-label="Export conversation">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    <span>Export</span>
                </button>
                <button id="settings-btn" class="theme-toggle" title="Settings" aria-label="Settings" onclick="openSettings()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15.4a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 8c.14.31.22.65.22 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
                <button id="theme-toggle" class="theme-toggle" title="Toggle theme (Alt+T)" aria-label="Toggle dark/light theme">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="light-icon"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="dark-icon" style="display:none;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
            </div>
        </header>
        
        <main class="chat-container">
        <div id="chat-history" class="chat-history">
                {% if messages %}
            {% for msg in messages %}
                <div class="msg-row {{ msg.role }}">
                            {% if msg.role == 'assistant' %}
                            <div class="avatar">
                                <span class="avatar-letter">A</span>
                            </div>
                            {% endif %}
                    <div class="bubble {{ msg.role }}-msg">
                                <!-- <span class="role">{{ msg.role.title() }}</span> -->
                                <span class="content">{{ msg.content_html|safe }}</span>
                                <span class="timestamp">{{ msg.timestamp }}</span>
                                <div class="message-actions">
                                    <button class="action-btn copy-btn" onclick="copyMessage(this)" aria-label="Copy message">
                                        <span class="action-tooltip">Copy</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                    </button>
                                </div>
                            </div>
                            {% if msg.role == 'user' %}
                            <div class="avatar">
                                <span class="avatar-letter">U</span>
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                        {% else %}
                    <div class="empty-chat">
                        <div class="empty-chat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.056 3 11.61c0 1.64.506 3.192 1.397 4.512L3 20.25l5.25-1.837A8.963 8.963 0 0 0 12 20.25z"></path></svg>
                        </div>
                        <h2>Welcome to DeepSeek Chat</h2>
                        <p>Type a message or upload a file to begin.</p>
                    </div>
                        {% endif %}
                {% if loading %}
                    <div class="msg-row assistant loading-placeholder">
                        <div class="avatar">
                            <span class="avatar-letter">A</span>
                        </div>
                        <div class="bubble assistant-msg loading-bubble">
                            <div class="typing-indicator">
                                <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
                    </div>
                </div>
                </div>
            {% endif %}
            </div>
            <div id="scroll-bottom" class="scroll-bottom-btn" title="Scroll to bottom">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
        </main>

        <form id="chat-form" method="post" onsubmit="sendChat(); return false;">
            <textarea id="user_message" name="user_message" placeholder="Type your message... (Shift+Enter for newline)" required rows="1" oninput="autoResizeTextarea(this)" onkeydown="handleKey(event)" aria-label="Message input"></textarea>
            <input type="hidden" id="user_name_hidden" name="user_name" />
            <input type="hidden" id="user_avatar_hidden" name="user_avatar" />
            <input type="hidden" id="system_prompt_hidden" name="system_prompt" />
            <button id="send-btn" type="submit" {% if loading %}disabled{% endif %} aria-label="Send message">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
            <button type="button" onclick="document.getElementById('reset-form').submit();" class="reset-btn" aria-label="Reset conversation">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>
            </button>
        </form>
        <form id="reset-form" method="post" action="/reset" style="display:none;"></form>
        
        <form id="upload-form" enctype="multipart/form-data">
            <label for="file-input">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.49"></path></svg>
                Attach File
            </label>
            <input type="file" id="file-input" name="file" accept="image/*,.pdf,.txt,.doc,.docx" />
            <button id="upload-btn" type="submit" style="display:none;">Upload File</button> <!-- Hidden, triggered by JS if needed or label click -->
            <progress id="upload-progress" value="0" max="100" style="display:none;"></progress>
            <span id="upload-status"></span>
            <div id="image-preview"></div>
        </form>
        <div id="sending-status" class="sending-indicator" style="display:none;"></div>

        <div id="upload-area" class="upload-area">
            <div class="upload-area-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            </div>
            <div class="upload-area-text">Drop files here or click to select</div>
        </div>
    </div>
    <script>
    // Theme Toggle, Scroll, Copy, Export, Drag/Drop, Keyboard shortcuts - existing JS
    const uploadForm = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn'); // Though hidden, might be used by JS
    const uploadProgress = document.getElementById('upload-progress');
    const uploadStatus = document.getElementById('upload-status');
    const imagePreview = document.getElementById('image-preview');

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            uploadStatus.textContent = `Selected: ${this.files[0].name}`;
            uploadProgress.style.display = 'block';
            // Automatically submit form on file selection
            submitUploadForm(); 
        }
    });

    async function submitUploadForm() {
        if (!fileInput.files.length) { 
            uploadStatus.textContent = 'No file selected'; 
            uploadProgress.style.display = 'none';
            return; 
        }
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        // Visually indicate upload start, even if button is hidden
        uploadStatus.textContent = 'Uploading...';
        uploadProgress.value = 0;
        uploadProgress.style.display = 'block';
        imagePreview.innerHTML = '';

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload', true);
        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                uploadProgress.value = (e.loaded / e.total) * 100;
            }
        };
        xhr.onload = function() {
            uploadProgress.style.display = 'none'; // Hide progress after completion/error
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                uploadStatus.textContent = '✓ Uploaded: ' + data.filename.substring(0,25)+(data.filename.length > 25 ? '...' : '');
                if (data.content_type.startsWith('image/')) {
                    const url = '/uploads/' + data.filename;
                    imagePreview.innerHTML = `<img src="${url}" alt="${data.filename}" />`;
                }
                // Add file message to chat history via SSE or similar mechanism if desired
                // For now, just confirm upload
            } else {
                uploadStatus.textContent = '✗ Upload failed';
            }
            // Reset file input for next upload
            fileInput.value = ''; 
            // Hide status after a few seconds
            setTimeout(() => { 
                if (!fileInput.files.length) uploadStatus.textContent = ''; 
                imagePreview.innerHTML = '';
            }, 4000);
        };
        xhr.onerror = function() {
            uploadProgress.style.display = 'none';
            uploadStatus.textContent = '✗ Upload failed (network error)';
            fileInput.value = '';
            setTimeout(() => { 
                if (!fileInput.files.length) uploadStatus.textContent = '';
                imagePreview.innerHTML = ''; 
            }, 4000);
        };
        xhr.send(formData);
    }
    
    uploadForm.onsubmit = async function(e) { 
        e.preventDefault(); 
        submitUploadForm();
    };

    // Image paste support
    document.getElementById('user_message').addEventListener('paste', async function(e) {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const file = items[i].getAsFile();
                if (file) {
                    // Use a DataTransfer object to set files on the input
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    // Trigger change event to start upload
                    fileInput.dispatchEvent(new Event('change'));
                    e.preventDefault(); // Prevent pasting image data into textarea
                    break; // Handle first image found
                }
            }
        }
    });

    // Auto-resize textarea on input
    document.getElementById('user_message').addEventListener('input', function() {
        autoResizeTextarea(this);
    });
    
    window.addEventListener('DOMContentLoaded', function() {
        var sendingStatus = document.getElementById('sending-status');
        if (sendingStatus) sendingStatus.style.display = 'none';
        // Initial resize for any pre-filled content (unlikely here, but good practice)
        autoResizeTextarea(document.getElementById('user_message'));
    });
    const chatHistoryElem = document.getElementById('chat-history');
    const scrollBottomBtn = document.getElementById('scroll-bottom');
    
    chatHistoryElem.addEventListener('scroll', function() {
        const isScrolledUp = chatHistoryElem.scrollTop < chatHistoryElem.scrollHeight - chatHistoryElem.clientHeight - 100; // Increased threshold
        if (isScrolledUp) {
            scrollBottomBtn.classList.add('visible');
        } else {
            scrollBottomBtn.classList.remove('visible');
        }
    });
    
    scrollBottomBtn.addEventListener('click', function() {
        chatHistoryElem.scrollTop = chatHistoryElem.scrollHeight;
    });
    
    function scrollChat() {
        const chatHistoryElem = document.getElementById('chat-history');
        const scrollBottomBtn = document.getElementById('scroll-bottom');
        // Hide if no messages or empty chat
        if (!chatHistoryElem || chatHistoryElem.children.length === 0 || chatHistoryElem.querySelector('.empty-chat')) {
            scrollBottomBtn.classList.remove('visible');
            return;
        }
        // Show only if not at bottom
        const isScrolledUp = chatHistoryElem.scrollTop < chatHistoryElem.scrollHeight - chatHistoryElem.clientHeight - 100;
        if (isScrolledUp && chatHistoryElem.scrollHeight > chatHistoryElem.clientHeight) {
            scrollBottomBtn.classList.add('visible');
        } else {
            scrollBottomBtn.classList.remove('visible');
        }
    }
    function copyMessage(button) {
        const contentEl = button.closest('.bubble').querySelector('.content');
        // Create a temporary div to get innerText without HTML tags from markdown
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = contentEl.innerHTML.replace(/<br\s*\/?>/ig, '\n'); // Convert <br> to newlines for copy
        const textToCopy = tempDiv.innerText || tempDiv.textContent || '';

        navigator.clipboard.writeText(textToCopy).then(function() {
            const tooltip = button.querySelector('.action-tooltip');
            tooltip.textContent = 'Copied!';
            button.classList.add('copied');
            setTimeout(function() {
                tooltip.textContent = 'Copy';
                button.classList.remove('copied');
            }, 1500);
        }).catch(function(err) {
            console.error('Could not copy text: ', err);
            const tooltip = button.querySelector('.action-tooltip');
            tooltip.textContent = 'Error!';
            setTimeout(function() {
                tooltip.textContent = 'Copy';
            }, 1500);
        });
    }
    const themeToggle = document.getElementById('theme-toggle');
    const htmlElement = document.documentElement;
    const lightIcon = themeToggle.querySelector('.light-icon');
    const darkIcon = themeToggle.querySelector('.dark-icon');
    
    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    setTheme(savedTheme);
    
    themeToggle.addEventListener('click', function() {
        const currentTheme = htmlElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
        localStorage.setItem('theme', newTheme);
    });
    
    function setTheme(theme) {
        htmlElement.setAttribute('data-theme', theme);
        if (theme === 'light') {
            lightIcon.style.display = 'inline-block';
            darkIcon.style.display = 'none';
        } else {
            lightIcon.style.display = 'none';
            darkIcon.style.display = 'inline-block';
        }
    }
    const uploadArea = document.getElementById('upload-area');
    // const fileInput = document.getElementById('file-input'); // Already defined
    
    document.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('visible');
    });
    
    document.addEventListener('dragleave', function(e) {
        // Check if the leave event is truly leaving the window/document or just moving over child elements
        if (!e.relatedTarget || e.relatedTarget.nodeName === 'HTML') {
            uploadArea.classList.remove('visible');
        } else if (e.clientX === 0 && e.clientY === 0) { // Heuristic for leaving window
             uploadArea.classList.remove('visible');
        }
    });
        
    uploadArea.addEventListener('dragover', function(e) { /* e.preventDefault(); is in global */ this.classList.add('drag-over'); });
    uploadArea.addEventListener('dragleave', function() { this.classList.remove('drag-over'); });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        this.classList.remove('visible');
        
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event('change')); // Trigger upload
        }
    });
    
    uploadArea.addEventListener('click', function() { fileInput.click(); });
    
    document.getElementById('export-btn').addEventListener('click', function() {
        const messages = Array.from(document.querySelectorAll('.msg-row'));
        let text = `# DeepSeek Chat Export - ${new Date().toLocaleString()}\n\n`;
        messages.forEach(msg => {
            const isUser = msg.classList.contains('user');
            const role = isUser ? 'User' : 'Assistant';
            const contentEl = msg.querySelector('.content');
            const time = msg.querySelector('.timestamp').textContent;
            
            // Create a temporary div to get innerText without HTML tags from markdown
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = contentEl.innerHTML.replace(/<br\s*\/?>/ig, '\n'); // Convert <br> to newlines
            const content = tempDiv.innerText || tempDiv.textContent || '';
            
            text += `## ${role} (${time})\n\n${content.trim()}\n\n---\n\n`;
        });
        
        const blob = new Blob([text], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `deepseek-chat-export-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.md`;
        document.body.appendChild(a); // Required for Firefox
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.altKey && e.key === 't') { e.preventDefault(); document.getElementById('theme-toggle').click(); }
        if (e.altKey && e.key === 'e') { e.preventDefault(); document.getElementById('export-btn').click(); }
        if (e.altKey && e.key === 'u') { e.preventDefault(); document.getElementById('file-input').click(); } // Updated to click label effectively
        if (e.altKey && e.key === 's') { e.preventDefault(); document.getElementById('user_message').focus(); }
        if (e.key === 'Escape') {
            if (uploadArea.classList.contains('visible')) uploadArea.classList.remove('visible');
        }
    });
    
    document.addEventListener('keyup', function(e) { if (e.key === 'Tab') document.body.classList.add('keyboard-nav'); });
    document.addEventListener('mousedown', function() { document.body.classList.remove('keyboard-nav'); });
    
    // Tool integration handling
    function insertToolPrompt(toolName, promptText) {
        const messageInput = document.getElementById('user_message');
        messageInput.value = promptText;
        messageInput.focus();
        
        // Place cursor at the end of text
        const textLength = messageInput.value.length;
        messageInput.setSelectionRange(textLength, textLength);
        
        // Auto-resize the textarea
        autoResizeTextarea(messageInput);
    }
    
    // Add tool quick access buttons in footer
    function createToolButton(toolName, icon, promptText) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'tool-quick-btn';
        button.title = `Use ${toolName}`;
        button.innerHTML = icon;
        button.addEventListener('click', function() {
            insertToolPrompt(toolName, promptText);
        });
        return button;
    }
    
    window.addEventListener('DOMContentLoaded', function() {
        // Set hidden fields from localStorage
        document.getElementById('user_name_hidden').value = localStorage.getItem('ds_username') || 'User';
        document.getElementById('user_avatar_hidden').value = localStorage.getItem('ds_avatar') || 'U';
        document.getElementById('system_prompt_hidden').value = localStorage.getItem('ds_system_prompt') || 'You are DeepSeek Chat, a helpful AI assistant.';
        
        // Set up settings tabs
        const tabButtons = document.querySelectorAll('.settings-tab-btn');
        const tabContents = document.querySelectorAll('.settings-tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // Deactivate all tabs
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Activate clicked tab
                this.classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
            });
        });
        
        // Set up tool toggle event handlers
        const toggles = document.querySelectorAll('.tool-config-header input[type="checkbox"]');
        toggles.forEach(toggle => {
            toggle.addEventListener('change', function() {
                const toolConfigItem = this.closest('.tool-config-item');
                const configBody = toolConfigItem.querySelector('.tool-config-body');
                
                if (configBody) {
                    configBody.style.display = this.checked ? 'block' : 'none';
                }
            });
        });
        
        // Set up API keys save button
        document.getElementById('save-api-keys-btn').addEventListener('click', saveApiKeys);
    });
    </script>
</body>
</html> 